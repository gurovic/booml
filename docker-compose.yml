services:
  postgres:
    container_name: booml-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: booml
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d booml"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    container_name: booml-redis
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      default:
        aliases:
          - redis

  runner-vm:
    image: runner-vm:latest
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    command: ["true"]

  backend:
    container_name: booml-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8100
      "
    working_dir: /app
    volumes:
      - ./backend:/app
      - ./problem_data:/problem_data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8100:8100"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      runner-vm:
        condition: service_started
    environment:
      DJANGO_SETTINGS_MODULE: core.settings
      SECRET_KEY: dev-secret-key
      DEBUG: "True"
      MODE: dev
      DB_NAME: booml
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: postgres
      DB_PORT: "5432"
      ALLOWED_HOSTS: booml.letovo.site,backend.booml.letovo.site,backend,localhost,127.0.0.1,0.0.0.0
      CSRF_TRUSTED_ORIGINS: http://localhost:8101,http://frontend:8101,http://booml.letovo.site,https://booml.letovo.site,http://backend.booml.letovo.site,https://backend.booml.letovo.site
      RUNTIME_EXECUTION_BACKEND: legacy
      RUNTIME_VM_BACKEND: docker
      PROBLEM_DATA_ROOT: /problem_data/problem_data
      # Host path corresponding to /app inside container; used for Docker VM bind mounts.
      RUNTIME_VM_HOST_ROOT: ${PWD}/backend
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      CHANNEL_LAYER_REDIS_URL: redis://redis:6379/2
      RUNNER_USE_CELERY_QUEUE: ${RUNNER_USE_CELERY_QUEUE:-1}

  celery:
    container_name: booml-celery
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        celery -A runner.celery:app worker -l info
      "
    working_dir: /app
    volumes:
      - ./backend:/app
      - ./problem_data:/problem_data
      - /var/run/docker.sock:/var/run/docker.sock
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DJANGO_SETTINGS_MODULE: core.settings
      SECRET_KEY: dev-secret-key
      DEBUG: "True"
      MODE: dev
      DB_NAME: booml
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: postgres
      DB_PORT: "5432"
      RUNTIME_VM_BACKEND: docker
      PROBLEM_DATA_ROOT: /problem_data/problem_data
      # Host path corresponding to /app inside container; used for Docker VM bind mounts.
      RUNTIME_VM_HOST_ROOT: ${PWD}/backend
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      CHANNEL_LAYER_REDIS_URL: redis://redis:6379/2
      RUNNER_USE_CELERY_QUEUE: ${RUNNER_USE_CELERY_QUEUE:-1}

  frontend:
    container_name: booml-frontend
    image: node:18
    working_dir: /app
    command: >
      sh -c "
        npm install &&
        npm run serve -- --host 0.0.0.0 --port 8101
      "
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      VUE_APP_API_BASE: /api
      VUE_APP_BACKEND_URL: http://backend:8100/
    ports:
      - "8101:8101"
    depends_on:
      - backend

volumes:
  frontend-node-modules:
  redis-data:
  postgres-data:
