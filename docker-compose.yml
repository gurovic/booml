version: "3.9"

services:
  backend:
    container_name: booml-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8100
      "
    working_dir: /app
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8100:8100"
    environment:
      DJANGO_SETTINGS_MODULE: core.settings
      SECRET_KEY: dev-secret-key
      DEBUG: "1"
      MODE: dev
      ALLOWED_HOSTS: booml.veconomics.ru,backend.booml.veconomics.ru,backend,localhost,127.0.0.1
      CSRF_TRUSTED_ORIGINS: http://localhost:8101,http://frontend:8101,http://booml.veconomics.ru,https://booml.veconomics.ru,http://backend.booml.veconomics.ru,https://backend.booml.veconomics.ru
      RUNTIME_EXECUTION_BACKEND: jupyter
      RUNTIME_VM_BACKEND: auto
      RUNNER_USE_CELERY_QUEUE: "0"

  frontend:
    container_name: booml-frontend
    image: node:18
    working_dir: /app
    command: >
      sh -c "
        npm install &&
        npm run serve -- --host 0.0.0.0 --port 8101
      "
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      VUE_APP_API_BASE: /api
      VUE_APP_BACKEND_URL: http://backend:8100/
    ports:
      - "8101:8101"
    depends_on:
      - backend

  notebooks:
    container_name: booml-notebooks
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    working_dir: /workspace
    command: >
      jupyter lab
        --ip=0.0.0.0
        --port=8888
        --no-browser
        --allow-root
        --NotebookApp.token=''
        --NotebookApp.password=''
        --NotebookApp.allow_remote_access=True
        --NotebookApp.notebook_dir=/workspace
    volumes:
      - ./backend/media/notebook_sessions:/workspace
    ports:
      - "8888:8888"

volumes:
  frontend-node-modules:
