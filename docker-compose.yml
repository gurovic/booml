version: "3.9"

services:
  redis:
    container_name: booml-redis
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      default:
        aliases:
          - redis

  backend:
    container_name: booml-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8100
      "
    working_dir: /app
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8100:8100"
    depends_on:
      redis:
        condition: service_healthy
    environment:
      DJANGO_SETTINGS_MODULE: core.settings
      SECRET_KEY: dev-secret-key
      DEBUG: "True"
      MODE: dev
      ALLOWED_HOSTS: booml.veconomics.ru,backend.booml.veconomics.ru,backend,localhost,127.0.0.1
      CSRF_TRUSTED_ORIGINS: http://localhost:8101,http://frontend:8101,http://booml.veconomics.ru,https://booml.veconomics.ru,http://backend.booml.veconomics.ru,https://backend.booml.veconomics.ru
      RUNTIME_EXECUTION_BACKEND: jupyter
      RUNTIME_VM_BACKEND: auto
      # Host path corresponding to /app inside container; used for Docker VM bind mounts.
      RUNTIME_VM_HOST_ROOT: ${PWD}/backend
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      CHANNEL_LAYER_REDIS_URL: redis://redis:6379/2
      RUNNER_USE_CELERY_QUEUE: ${RUNNER_USE_CELERY_QUEUE:-1}

  celery:
    container_name: booml-celery
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: >
      sh -c "
        celery -A runner.celery:app worker -l info
      "
    working_dir: /app
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      redis:
        condition: service_healthy
    environment:
      DJANGO_SETTINGS_MODULE: core.settings
      SECRET_KEY: dev-secret-key
      DEBUG: "True"
      MODE: dev
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/1
      CHANNEL_LAYER_REDIS_URL: redis://redis:6379/2
      RUNNER_USE_CELERY_QUEUE: ${RUNNER_USE_CELERY_QUEUE:-1}

  frontend:
    container_name: booml-frontend
    image: node:18
    working_dir: /app
    command: >
      sh -c "
        npm install &&
        npm run serve -- --host 0.0.0.0 --port 8101
      "
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      VUE_APP_API_BASE: /api
      VUE_APP_BACKEND_URL: http://backend:8100/
    ports:
      - "8101:8101"
    depends_on:
      - backend

  notebooks:
    container_name: booml-notebooks
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    working_dir: /workspace
    command: >
      jupyter lab
        --ip=0.0.0.0
        --port=8888
        --no-browser
        --allow-root
        --NotebookApp.token=''
        --NotebookApp.password=''
        --NotebookApp.allow_remote_access=True
        --NotebookApp.notebook_dir=/workspace
    volumes:
      - ./backend/media/notebook_sessions:/workspace
    ports:
      - "8888:8888"

volumes:
  frontend-node-modules:
  redis-data:
