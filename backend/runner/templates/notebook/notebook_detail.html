<!DOCTYPE html>
<html>
<head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>{{ notebook.title }}</title>
    {% load static %}
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                typeset: false,
                ready: () => {
                    MathJax.startup.defaultReady();
                    if (window.NotebookUtils?.flushLatexQueue) {
                        window.NotebookUtils.flushLatexQueue();
                    }
                }
            }
        };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="{% static 'notebook/js/utils.js' %}"></script>
    <script src="{% static 'notebook/js/notebook_detail.js' %}"></script>
    <style>
        .cell.clipboard-highlight {
            border: 1px solid #4caf50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.4);
        }
        .clipboard-indicator {
            margin-left: 12px;
            font-size: 14px;
            color: #444;
        }
        .clipboard-indicator[data-state="empty"] {
            color: #777;
            font-style: italic;
        }
        [data-paste-button][disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #cells-container {
            max-width: 95% !important;
            margin: 0 auto;
        }
        
        .cell {
            width: 100%;
            box-sizing: border-box;
        }
        
        .cell-content {
            width: 100%;
            box-sizing: border-box;
        }
        
        .cell-content textarea {
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .output-html table,
        .output-markdown table,
        .output-text table {
            border-collapse: collapse;
            width: auto;
            max-width: 100%;
            font-size: 13px;
            color: #222;
        }

        .output-html table.dataframe,
        .output-markdown table.dataframe {
            border: 1px solid #e0e0e0;
            background: #fff;
        }

        .output-html table.dataframe thead th,
        .output-markdown table.dataframe thead th {
            position: sticky;
            top: 0;
            background: #f6f6f6;
            font-weight: 600;
            border-bottom: 1px solid #d8d8d8;
            padding: 6px 10px;
            text-align: right;
            white-space: nowrap;
        }

        .output-html table.dataframe tbody th,
        .output-markdown table.dataframe tbody th {
            background: #fafafa;
            font-weight: 600;
            text-align: right;
            padding: 6px 10px;
            border-right: 1px solid #eee;
            white-space: nowrap;
        }

        .output-html table.dataframe td,
        .output-markdown table.dataframe td {
            padding: 6px 10px;
            border-top: 1px solid #eee;
            text-align: right;
            white-space: nowrap;
        }

        .output-html table.dataframe tbody tr:nth-child(even),
        .output-markdown table.dataframe tbody tr:nth-child(even) {
            background: #f7f9fc;
        }

        .output-html table.dataframe tbody tr:hover,
        .output-markdown table.dataframe tbody tr:hover {
            background: #f1f7ff;
        }

        .output-html .dataframe-container,
        .output-markdown .dataframe-container {
            overflow: auto;
            max-width: 100%;
            max-height: 360px;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
        }

        .output-html .dataframe-container.dataframe-expanded,
        .output-markdown .dataframe-container.dataframe-expanded {
            max-height: none;
        }

        .output-html .dataframe-container::-webkit-scrollbar,
        .output-markdown .dataframe-container::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        .output-html .dataframe-container::-webkit-scrollbar-thumb,
        .output-markdown .dataframe-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .output-html .dataframe-container::-webkit-scrollbar-track,
        .output-markdown .dataframe-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .dataframe-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0;
            font-size: 12px;
            color: #444;
        }

        .dataframe-toolbar button {
            border: 1px solid #d0d0d0;
            background: #f7f7f7;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .dataframe-toolbar button:hover {
            background: #eef3ff;
            border-color: #b5c7ff;
        }

        .dataframe-summary {
            margin-right: auto;
            color: #666;
        }

        .dataframe-search {
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            min-width: 160px;
        }

        .dataframe-search:focus {
            outline: none;
            border-color: #9bb8ff;
            box-shadow: 0 0 0 2px rgba(155, 184, 255, 0.3);
        }

        .dataframe-info {
            background: #f7f9ff;
            border: 1px solid #dbe3ff;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 12px;
            color: #334;
            margin: 6px 0 10px;
        }

        .dataframe-info table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            font-size: 12px;
        }

        .dataframe-info th,
        .dataframe-info td {
            border-bottom: 1px solid #e6e9f5;
            padding: 4px 6px;
            text-align: left;
        }

        .dataframe-info th {
            color: #445;
            font-weight: 600;
            background: #eef2ff;
        }

        .df-info-title {
            font-weight: 600;
            margin-top: 6px;
        }

        .df-info-note {
            margin-top: 6px;
            color: #667;
        }

        .output-html table.dataframe td.df-null,
        .output-markdown table.dataframe td.df-null {
            background: #fff4cc;
            color: #7a4b00;
        }
    </style>
</head>
<body>
    <div id="notebook-{{ notebook.id }}"
         data-notebook-id="{{ notebook.id }}"
         data-create-cell-url="{% url 'runner:create_cell' notebook.id %}"
         data-create-latex-cell-url="{% url 'runner:create_latex_cell' notebook.id %}"
         data-run-cell-url="{% url 'run-cell' %}"
         data-run-cell-stream-start-url="{% url 'run-cell-stream-start' %}"
         data-run-cell-stream-status-url="{% url 'run-cell-stream-status' %}"
         data-session-create-url="{% url 'notebook-session-create' %}"
         data-session-reset-url="{% url 'session-reset' %}"
         data-session-files-url="{% url 'session-files' %}"
         data-session-file-upload-url="{% url 'session-file-upload' %}"
         data-session-file-download-url="{% url 'session-file-download' %}"
         data-session-file-preview-url="{% url 'session-file-preview' %}"
         data-session-stop-url="{% url 'session-stop' %}"
         data-notebook-device="{{ notebook.compute_device }}"
         data-update-device-url="{% url 'runner:update_notebook_device' notebook.id %}"
         data-delete-url-template="{% url 'runner:delete_cell' notebook.id 0 %}"
         data-copy-cell-url-template="{% url 'runner:copy_cell' notebook.id 0 %}"
         data-move-cell-url-template="{% url 'runner:move_cell' notebook.id 0 %}"
         data-save-output-url-template="{% url 'runner:save_cell_output' notebook.id 0 %}">

        <div class="notebook-header">
            <div class="notebook-header-title">
                <a class="notebook-back-link" href="{% url 'runner:notebook_list' %}">‚Üê –ö —Å–ø–∏—Å–∫—É –±–ª–æ–∫–Ω–æ—Ç–æ–≤</a>
                <h1 id="notebook-title">{{ notebook.title }}</h1>
            </div>
            <form id="rename-notebook-form"
                  class="notebook-rename-form"
                  method="post"
                  action="{% url 'runner:rename_notebook' notebook.id %}">
                {% csrf_token %}
                <label for="notebook-rename-input">–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text"
                       id="notebook-rename-input"
                       name="title"
                       value="{{ notebook.title }}"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–Ω–æ—Ç–∞">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>

        <div class="session-controls" data-session-controls>
            <div class="session-status-row">
                <span>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏:</span>
                <span data-session-status>–°–µ—Å—Å–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</span>
            </div>
            <div class="session-status-row">
                <span>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π:</span>
                <label>
                    <select data-compute-device>
                        <option value="cpu">CPU</option>
                        <option value="gpu">GPU</option>
                    </select>
                </label>
                <span data-compute-device-hint style="margin-left: 8px; color: #666; font-size: 12px;">
                    –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Å—Å–∏–∏
                </span>
            </div>
            <div class="session-actions">
                <button type="button" data-action="create-session">üöÄ –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é</button>
                <button type="button" data-action="reset-session">‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
                <button type="button" data-action="stop-session">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            </div>
        </div>

        <aside class="notebook-files-panel" data-files-panel>
            <div class="files-panel-header">
                <span>–§–∞–π–ª—ã —Å–µ—Å—Å–∏–∏</span>
                <div class="files-panel-actions">
                    <button type="button" data-action="refresh-files">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button type="button" data-action="upload-file">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                    <input type="file" data-upload-input multiple style="display: none;">
                </div>
            </div>
            <div class="files-panel-body">
                <div data-files-list>
                    <div class="files-empty">–§–∞–π–ª—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</div>
                </div>
                <div data-files-preview></div>
            </div>
        </aside>

        <div class="notebook-actions">
            <form id="delete-notebook-form"
                  class="delete-notebook-form"
                  method="post"
                  action="{% url 'runner:delete_notebook' notebook.id %}">
                {% csrf_token %}
                <button type="submit" data-action="delete-notebook">üóë –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–Ω–æ—Ç</button>
            </form>
            <button data-action="export-notebook">üì• –≠–∫—Å–ø–æ—Ä—Ç –Ω–æ—É—Ç–±—É–∫–∞</button>
            <button data-action="import-notebook">üì§ –ò–º–ø–æ—Ä—Ç –Ω–æ—É—Ç–±—É–∫–∞</button>
            <input type="file" id="import-file-input" accept=".json" style="display: none;" data-import-url="{% url 'runner:import_notebook' %}">
            <button data-action="create-cell">‚ûï –ù–æ–≤–∞—è —è—á–µ–π–∫–∞ –∫–æ–¥–∞</button>
            <button data-action="create-latex-cell">‚ûï –ù–æ–≤–∞—è LaTeX-—è—á–µ–π–∫–∞</button>
            <button onclick="runAll()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —è—á–µ–π–∫–∏ —Å –∫–æ–¥–æ–º</button>
            <button data-action="paste-at-end" data-paste-button disabled>üìã –í—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü</button>
            <span class="clipboard-indicator" data-clipboard-indicator data-state="empty">–ë—É—Ñ–µ—Ä –ø—É—Å—Ç</span>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ -->
        <div id="import-export-status" style="display: none; margin: 10px 0; padding: 10px; border-radius: 4px;"></div>

        <div id="cells-container">
            {% for cell in cells %}
                {% include 'notebook/cell.html' with cell=cell notebook=notebook %}
            {% endfor %}
        </div>
    </div>

    {% csrf_token %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            notebookDetail.init({
                notebookId: {{ notebook.id }},
                csrfToken: '{{ csrf_token }}',
                runCellUrl: '{% url "run-cell" %}',
                runCellStreamStartUrl: '{% url "run-cell-stream-start" %}',
                runCellStreamStatusUrl: '{% url "run-cell-stream-status" %}',
                sessionCreateUrl: '{% url "notebook-session-create" %}',
                sessionResetUrl: '{% url "session-reset" %}',
                sessionFilesUrl: '{% url "session-files" %}',
                sessionFilePreviewUrl: '{% url "session-file-preview" %}',
                sessionFileDownloadUrl: '{% url "session-file-download" %}',
                sessionStopUrl: '{% url "session-stop" %}'
            });
        });
    </script>
</body>
</html>
